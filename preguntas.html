<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preguntas para Cami</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .preguntas-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pregunta-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            position: relative;
        }
        
        .progreso {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .paso {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            z-index: 2;
        }
        
        .paso.activo {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }
        
        .paso.completado {
            background: #4CAF50;
            color: white;
        }
        
        .linea-progreso {
            position: absolute;
            top: 50%;
            left: 17px;
            right: 17px;
            height: 3px;
            background: #e0e0e0;
            z-index: 1;
            transform: translateY(-50%);
        }
        
        .linea-progreso-activa {
            position: absolute;
            top: 50%;
            left: 17px;
            height: 3px;
            background: #4CAF50;
            z-index: 1;
            transform: translateY(-50%);
            transition: width 0.5s ease;
        }
        
        .pregunta-texto {
            font-size: 22px;
            margin-bottom: 30px;
            color: #333;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .respuesta-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 25px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .respuesta-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .opciones {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .opcion-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 25px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .opcion-btn:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .opcion-btn.seleccionado {
            background: #667eea;
            color: white;
        }
        
        .btn-siguiente {
            background: #764ba2;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            float: right;
        }
        
        .btn-siguiente:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-siguiente:hover:not(:disabled) {
            background: #5a3890;
            transform: translateY(-2px);
        }
        
        .pregunta-numero {
            color: #667eea;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .contador {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f0f4ff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #667eea;
            font-weight: bold;
        }
        
        /* PANEL ADMIN PARA TÍ */
        .panel-admin {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            transition: all 0.3s;
            display: none;
            opacity: 0.8;
        }
        
        .panel-admin:hover {
            transform: translateY(-3px);
            background: #1976D2;
            opacity: 1;
        }
        
        /* MODAL ADMIN */
        .modal-admin {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .modal-contenido {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-titulo {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-size: 20px;
        }
        
        .respuesta-item {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #4CAF50;
            font-size: 13px;
        }
        
        .respuesta-fecha {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }
        
        .btn-cerrar {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            font-size: 14px;
        }
        
        /* LOADING */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* NOTIFICACIÓN */
        .notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 9999;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="preguntas-container">
        <div class="pregunta-box">
            <div class="contador" id="contador">Pregunta 1 de 5</div>
            
            <!-- Barra de progreso -->
            <div class="progreso">
                <div class="linea-progreso"></div>
                <div class="linea-progreso-activa" id="lineaProgreso"></div>
                <div class="paso activo" id="paso1">1</div>
                <div class="paso" id="paso2">2</div>
                <div class="paso" id="paso3">3</div>
                <div class="paso" id="paso4">4</div>
                <div class="paso" id="paso5">5</div>
            </div>
            
            <!-- Contenedor de preguntas -->
            <div id="contenedorPreguntas">
                <!-- Las preguntas se cargarán dinámicamente aquí -->
            </div>
            
            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Guardando respuestas en Google Sheets...</p>
            </div>
        </div>
        
        <!-- Notificación -->
        <div class="notificacion" id="notificacion"></div>
        
        <!-- Panel admin (sólo visible para ti) -->
        <div class="panel-admin" id="panelAdmin">
            <i class="fas fa-eye"></i> Ver respuestas
        </div>
        
        <!-- Modal para ver respuestas -->
        <div class="modal-admin" id="modalAdmin">
            <div class="modal-contenido">
                <h3 class="modal-titulo">
                    <i class="fas fa-database"></i> Respuestas de Cami
                </h3>
                
                <div id="adminInfo" style="text-align: center; margin-bottom: 15px; font-size: 14px;">
                    <p>Cargando respuestas...</p>
                </div>
                
                <div id="respuestasLista">
                    <!-- Aquí se cargarán las respuestas -->
                </div>
                
                <button class="btn-cerrar" onclick="cerrarModal()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURACIÓN - URL DE TU GOOGLE APPS SCRIPT
        // =============================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw0LzC598QjPwEQjsACo8UDfyLgbunQAtzSxiUBkmcucxuvHEpmtdz104S42k3H4TLQeg/exec";
        const ADMIN_KEY = "salomon123"; // Cambia esta clave si quieres
        // =============================================
        
        // Array de preguntas
        const preguntas = [
            {
                id: 1,
                texto: "¿Qué te ha parecido hasta los momentos mi existencia en tu vida?",
                tipo: "texto",
                respuesta: "",
                numero: 1
            },
            {
                id: 2,
                texto: "¿Me vas a terminar de pasar tu Curriculum algún día?",
                tipo: "si_no",
                opciones: ["Sí", "No"],
                respuesta: "",
                numero: 2
            },
            {
                id: 3,
                texto: "¿Algún día veré el casting?",
                tipo: "si_no",
                opciones: ["Sí", "No"],
                respuesta: "",
                numero: 3
            },
            {
                id: 4,
                texto: "¿Cuándo me invitas a una colaboración en TikTok?",
                tipo: "texto",
                respuesta: "",
                numero: 4
            },
            {
                id: 5,
                texto: "¿Me vas a explicar química?",
                tipo: "si_no",
                opciones: ["Sí", "No"],
                respuesta: "",
                numero: 5
            }
        ];
        
        let preguntaActual = 0;
        let todasLasRespuestas = [];
        
        // Elementos DOM
        const contenedorPreguntas = document.getElementById('contenedorPreguntas');
        const contador = document.getElementById('contador');
        const lineaProgreso = document.getElementById('lineaProgreso');
        const loading = document.getElementById('loading');
        const panelAdmin = document.getElementById('panelAdmin');
        const modalAdmin = document.getElementById('modalAdmin');
        const adminInfo = document.getElementById('adminInfo');
        const respuestasLista = document.getElementById('respuestasLista');
        const notificacion = document.getElementById('notificacion');
        
        // Función para mostrar notificación
        function mostrarNotificacion(mensaje, tipo = 'success') {
            notificacion.textContent = mensaje;
            notificacion.style.background = tipo === 'success' ? '#4CAF50' : 
                                           tipo === 'error' ? '#f44336' : '#2196F3';
            notificacion.style.display = 'block';
            
            setTimeout(() => {
                notificacion.style.display = 'none';
            }, 3000);
        }
        
        // Función para obtener IP
        async function obtenerIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log("No se pudo obtener la IP");
                return "No disponible";
            }
        }
        
        // Función para guardar respuestas en Google Sheets
        async function guardarRespuestasGoogleSheets() {
            const fecha = new Date();
            
            // Obtener IP
            const ip = await obtenerIP();
            
            // Preparar datos para enviar - FORMATO CORREGIDO
            const datos = {
                tipo: "preguntas",
                nombre: "Cami",
                fecha: fecha.toLocaleString('es-ES'),
                timestamp: fecha.toISOString(),
                ip: ip,
                preguntas: preguntas.map(p => ({
                    pregunta: p.texto,
                    respuesta: p.respuesta || "No respondida",
                    tipo: p.tipo,
                    numero: p.numero
                }))
            };
            
            console.log("Enviando datos a Google Sheets:", datos);
            
            try {
                // Mostrar loading
                loading.style.display = 'block';
                
                // Enviar a Google Sheets
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });
                
                console.log("Respuesta del servidor:", response);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log("Google Sheets respondió:", result);
                    
                    if (result.success) {
                        mostrarNotificacion('✅ Respuestas guardadas en Google Sheets', 'success');
                    } else {
                        mostrarNotificacion('⚠️ Error guardando en Google Sheets', 'error');
                    }
                } else {
                    console.error("Error HTTP:", response.status);
                    mostrarNotificacion('⚠️ Error de conexión con Google Sheets', 'error');
                }
                
                // También guardar localmente
                todasLasRespuestas.push(datos);
                localStorage.setItem('respuestas_preguntas_cami', JSON.stringify(todasLasRespuestas));
                
                return true;
            } catch (error) {
                console.error("Error guardando en Google Sheets:", error);
                mostrarNotificacion('⚠️ Error de conexión', 'error');
                
                // Fallback: guardar solo localmente
                todasLasRespuestas.push(datos);
                localStorage.setItem('respuestas_preguntas_cami', JSON.stringify(todasLasRespuestas));
                
                return true;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Función para actualizar progreso
        function actualizarProgreso() {
            const porcentaje = (preguntaActual / (preguntas.length - 1)) * 100;
            lineaProgreso.style.width = `${porcentaje}%`;
            
            // Actualizar pasos
            for (let i = 1; i <= preguntas.length; i++) {
                const paso = document.getElementById(`paso${i}`);
                if (i - 1 < preguntaActual) {
                    paso.className = 'paso completado';
                } else if (i - 1 === preguntaActual) {
                    paso.className = 'paso activo';
                } else {
                    paso.className = 'paso';
                }
            }
            
            contador.textContent = `Pregunta ${preguntaActual + 1} de ${preguntas.length}`;
        }
        
        // Función para mostrar pregunta actual
        function mostrarPregunta() {
            const pregunta = preguntas[preguntaActual];
            
            let html = `
                <div class="pregunta-numero">
                    <i class="fas fa-question-circle"></i>
                    Pregunta #${pregunta.numero}
                </div>
                <div class="pregunta-texto">${pregunta.texto}</div>
            `;
            
            if (pregunta.tipo === 'texto') {
                html += `
                    <textarea class="respuesta-input" 
                              id="respuestaTexto" 
                              placeholder="Escribe tu respuesta aquí, porfavor y gracias"
                              oninput="guardarRespuestaTexto(this.value)">${pregunta.respuesta || ''}</textarea>
                `;
            } else if (pregunta.tipo === 'si_no') {
                html += `
                    <div class="opciones">
                        ${pregunta.opciones.map(opcion => `
                            <button class="opcion-btn ${pregunta.respuesta === opcion ? 'seleccionado' : ''}"
                                    onclick="seleccionarOpcion('${opcion}')">
                                ${opcion}
                            </button>
                        `).join('')}
                    </div>
                `;
            }
            
            html += `
                <div style="clear: both; padding-top: 20px;">
                    ${preguntaActual > 0 ? `
                        <button class="btn-siguiente" onclick="preguntaAnterior()" style="float: left; background: #666;">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                    ` : ''}
                    
                    <button class="btn-siguiente" id="btnSiguiente" 
                            onclick="${preguntaActual === preguntas.length - 1 ? 'finalizarPreguntas()' : 'siguientePregunta()'}"
                            ${!pregunta.respuesta ? 'disabled' : ''}>
                        ${preguntaActual === preguntas.length - 1 ? 'Finalizar' : 'Siguiente'}
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `;
            
            contenedorPreguntas.innerHTML = html;
            actualizarProgreso();
        }
        
        // Funciones para manejar respuestas
        function guardarRespuestaTexto(valor) {
            preguntas[preguntaActual].respuesta = valor.trim();
            document.getElementById('btnSiguiente').disabled = !valor.trim();
        }
        
        function seleccionarOpcion(opcion) {
            preguntas[preguntaActual].respuesta = opcion;
            
            // Actualizar botones
            document.querySelectorAll('.opcion-btn').forEach(btn => {
                btn.classList.remove('seleccionado');
                if (btn.textContent.trim() === opcion) {
                    btn.classList.add('seleccionado');
                }
            });
            
            document.getElementById('btnSiguiente').disabled = false;
        }
        
        // Navegación entre preguntas
        function siguientePregunta() {
            if (preguntaActual < preguntas.length - 1) {
                preguntaActual++;
                mostrarPregunta();
            }
        }
        
        function preguntaAnterior() {
            if (preguntaActual > 0) {
                preguntaActual--;
                mostrarPregunta();
            }
        }
        
        // Función para finalizar preguntas
        async function finalizarPreguntas() {
            // Verificar que todas estén respondidas
            const sinResponder = preguntas.filter(p => !p.respuesta);
            
            if (sinResponder.length > 0) {
                alert('Por favor, responde todas las preguntas antes de finalizar.');
                preguntaActual = sinResponder[0].numero - 1;
                mostrarPregunta();
                return;
            }
            
            // Guardar en Google Sheets
            const guardado = await guardarRespuestasGoogleSheets();
            
            if (guardado) {
                // Redirigir a la invitación final después de 2 segundos
                setTimeout(() => {
                    window.location.href = "invitacion.html";
                }, 2000);
            }
        }
        
        // Cargar respuestas guardadas (si las hay)
        function cargarRespuestasGuardadas() {
            const guardadas = localStorage.getItem('respuestas_preguntas_cami');
            if (guardadas) {
                try {
                    todasLasRespuestas = JSON.parse(guardadas);
                    console.log(`${todasLasRespuestas.length} respuestas cargadas de localStorage`);
                } catch (error) {
                    console.error("Error parseando localStorage:", error);
                }
            }
        }
        
        // Cargar y mostrar respuestas en el panel admin
        function cargarRespuestasPanel() {
            try {
                const guardadas = localStorage.getItem('respuestas_preguntas_cami');
                if (guardadas) {
                    todasLasRespuestas = JSON.parse(guardadas);
                    
                    adminInfo.innerHTML = `
                        <p><strong>${todasLasRespuestas.length}</strong> sesiones de preguntas completadas</p>
                        <p style="font-size: 12px; color: #666;">(Última: ${todasLasRespuestas[todasLasRespuestas.length-1]?.fecha})</p>
                    `;
                    
                    if (todasLasRespuestas.length > 0) {
                        const ultimaSesion = todasLasRespuestas[todasLasRespuestas.length - 1];
                        
                        let html = '<h4 style="margin: 15px 0 10px 0; color: #333;">Últimas respuestas:</h4>';
                        
                        ultimaSesion.preguntas.forEach((pregunta, i) => {
                            html += `
                                <div class="respuesta-item">
                                    <strong>P${i+1}:</strong> ${pregunta.pregunta}<br>
                                    <strong>Respuesta:</strong> ${pregunta.respuesta}<br>
                                    <span class="respuesta-fecha">${ultimaSesion.fecha} | IP: ${ultimaSesion.ip}</span>
                                </div>
                            `;
                        });
                        
                        respuestasLista.innerHTML = html;
                    }
                } else {
                    adminInfo.innerHTML = '<p>No hay respuestas guardadas todavía</p>';
                }
            } catch (error) {
                console.error("Error cargando respuestas:", error);
                adminInfo.innerHTML = '<p>Error cargando respuestas</p>';
            }
        }
        
        // Mostrar modal admin
        function mostrarModalAdmin() {
            modalAdmin.style.display = 'flex';
            cargarRespuestasPanel();
        }
        
        // Cerrar modal
        function cerrarModal() {
            modalAdmin.style.display = 'none';
        }
        
        // Verificar si es admin
        function verificarAdmin() {
            const esAdmin = localStorage.getItem('es_admin_preguntas') === 'true';
            if (esAdmin) {
                panelAdmin.style.display = 'block';
            }
            
            // Modo secreto: Si presionas 5 veces seguidas el título
            let clicksTitulo = 0;
            document.addEventListener('click', function(e) {
                if (e.target.closest('.pregunta-texto') || e.target.closest('.pregunta-numero')) {
                    clicksTitulo++;
                    setTimeout(() => { clicksTitulo = 0; }, 2000);
                    
                    if (clicksTitulo === 5) {
                        const clave = prompt("Ingresa la clave de administrador:");
                        if (clave === ADMIN_KEY) {
                            localStorage.setItem('es_admin_preguntas', 'true');
                            panelAdmin.style.display = 'block';
                            alert("Modo administrador activado ✓");
                        }
                    }
                }
            });
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Preguntas cargadas");
            console.log("URL de Google Apps Script:", GOOGLE_SCRIPT_URL);
            
            cargarRespuestasGuardadas();
            verificarAdmin();
            mostrarPregunta();
            
            // Panel admin
            panelAdmin.addEventListener('click', mostrarModalAdmin);
            
            // Cerrar modal al hacer clic fuera
            modalAdmin.addEventListener('click', function(e) {
                if (e.target === this) {
                    cerrarModal();
                }
            });
            
            // Depuración: Mostrar en consola
            console.log("Configuración lista:");
            console.log("- Preguntas:", preguntas.length);
            console.log("- Google Script:", GOOGLE_SCRIPT_URL);
            console.log("- Clave Admin:", ADMIN_KEY);
        });
    </script>
</body>
</html>
